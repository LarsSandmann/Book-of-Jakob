<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book of Jakob - Final Bugfix</title>
    <style>
        /* --- GRUNDEINSTELLUNGEN --- */
        :root {
            --gold-light: #f3e5ab;
            --gold: #d4af37;
            --gold-dark: #aa8822;
            --ui-bg-dark: #111;
        }

        body {
            /* DEIN HINTERGRUNDBILD */
            background-image: url('dsc05439-1000x668.jpeg');
            background-size: cover;
            background-position: center top;
            background-repeat: no-repeat;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 100vh;
            margin: 0;
            color: white;
            overflow: hidden;
            user-select: none;
            box-shadow: inset 0 0 200px rgba(0,0,0,0.8);
        }

        body::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.65); z-index: -1;
        }
        
        body.bonus-active::before {
            background: rgba(80, 0, 0, 0.7); /* Roter Schimmer im Bonus */
            transition: background 1s;
        }

        /* --- TITEL --- */
        .title-container {
            position: absolute;
            top: 20px;
            text-align: center;
            z-index: 10;
        }
        .game-title {
            font-size: 3.8rem;
            font-weight: 900;
            text-transform: uppercase;
            background: linear-gradient(to bottom, var(--gold-light) 20%, var(--gold) 50%, var(--gold-dark) 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.9));
            position: relative;
            display: inline-block;
            letter-spacing: 2px;
            margin: 0;
        }
        .game-title .red-dot {
            display: inline-block; width: 25px; height: 25px;
            background: radial-gradient(circle, #ff4444, #990000);
            border-radius: 50%; border: 2px solid var(--gold);
            margin: 0 4px; transform: translateY(-8px);
            box-shadow: 0 0 5px red;
        }

        .bonus-indicator {
            display: none;
            color: #ff3333; font-size: 2rem; font-weight: bold;
            text-shadow: 0 0 15px red; margin-top: 5px;
            animation: pulse 0.5s infinite alternate;
        }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }

        /* --- WALZEN --- */
        .main-game-area {
            display: flex; gap: 12px; padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid var(--gold-dark);
            border-radius: 15px; margin-bottom: 20px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .reel-frame {
            padding: 5px;
            background: linear-gradient(to bottom, #443300, #aa8822, #443300);
            border-radius: 6px; box-shadow: inset 0 0 10px #000;
        }

        .reel {
            width: 95px; height: 285px;
            background: #fdfdfd;
            border-radius: 4px; overflow: hidden;
            display: flex; flex-direction: column; position: relative;
        }
        .reel::after {
            content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 15%, rgba(0,0,0,0) 85%, rgba(0,0,0,0.6) 100%);
            pointer-events: none;
        }

        /* --- SYMBOLE --- */
        .symbol {
            height: 95px; width: 95px; flex-shrink: 0;
            display: flex; justify-content: center; align-items: center;
            font-size: 50px; font-family: 'Times New Roman', serif; font-weight: bold;
        }

        .symbol img.jakob-symbol {
            width: 90%; height: 90%; object-fit: cover; object-position: center 20%;
            border-radius: 5px; border: 3px solid var(--gold);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .sym-text { -webkit-text-stroke: 1px #000; text-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        .sym-10 { color: #1e90ff; font-family: sans-serif; letter-spacing: -5px; }
        .sym-J  { color: #1e90ff; }
        .sym-Q  { color: #32cd32; }
        .sym-K  { color: #ff4500; }
        .sym-A  { color: #ffd700; }
        .sym-emoji { filter: drop-shadow(0 0 2px #000); }

        .symbol.win-anim {
            background-color: rgba(255, 215, 0, 0.4);
            animation: pop 0.6s infinite alternate; z-index: 10;
        }
        @keyframes pop { from { transform: scale(0.9); } to { transform: scale(1.1); } }

        /* --- UI LEISTE --- */
        .bottom-ui-bar {
            width: 100%;
            background: linear-gradient(to bottom, #222, #000);
            border-top: 4px solid var(--gold);
            padding: 10px 20px;
            display: flex; justify-content: center; gap: 15px; align-items: center;
            box-shadow: 0 -5px 20px #000;
        }

        .ui-group {
            background: #222; border: 1px solid #444; border-radius: 5px;
            padding: 5px 10px; display: flex; flex-direction: column; align-items: center;
        }
        .label { color: #888; font-size: 10px; text-transform: uppercase; margin-bottom: 2px; }

        input.bet-input {
            background: #000; color: #fff; border: 1px solid var(--gold);
            width: 80px; text-align: center; font-size: 18px; font-weight: bold;
            padding: 5px; border-radius: 4px;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .balance-display { color: #fff; font-size: 18px; font-weight: bold; min-width: 100px; text-align: center; }

        .btn {
            border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer;
            box-shadow: 0 3px 0 rgba(0,0,0,0.5); transition: transform 0.1s;
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        
        .btn-auto { background: #3498db; width: 60px; height: 50px; font-size: 12px; }
        .btn-auto.active { background: #e74c3c; animation: blinkBorder 1s infinite; }
        @keyframes blinkBorder { 50% { border: 1px solid #fff; } }

        .btn-spin {
            background: linear-gradient(to bottom, #27ae60, #2ecc71);
            width: 100px; height: 60px; font-size: 20px;
            border: 2px solid #2ecc71; text-shadow: 1px 1px 0 #000;
        }
        .btn-spin:disabled { filter: grayscale(1); cursor: not-allowed; }

        /* OVERLAY */
        .overlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: rgba(0,0,0,0.95); padding: 40px; border: 4px solid var(--gold);
            text-align: center; border-radius: 20px; z-index: 100; transition: transform 0.3s;
            box-shadow: 0 0 100px var(--gold);
        }
        .overlay.show { transform: translate(-50%, -50%) scale(1); }
        .overlay h1 { color: var(--gold); font-size: 50px; margin: 0; text-shadow: 0 0 10px #fff; }
        .overlay h2 { color: #fff; margin: 10px 0 0 0; font-size: 30px; }

        .particle { position: fixed; width: 15px; height: 15px; background: gold; z-index: 200; pointer-events: none; }
    </style>
</head>
<body>

    <div class="title-container">
        <div class="game-title">BOOK <span class="red-dot"></span>F JAKOB</div>
        <div class="bonus-indicator" id="bonusText">!!! FREISPIELE !!!</div>
    </div>

    <div class="main-game-area">
        <div class="reel-frame"><div class="reel" id="reel0"></div></div>
        <div class="reel-frame"><div class="reel" id="reel1"></div></div>
        <div class="reel-frame"><div class="reel" id="reel2"></div></div>
        <div class="reel-frame"><div class="reel" id="reel3"></div></div>
        <div class="reel-frame"><div class="reel" id="reel4"></div></div>
    </div>

    <div class="overlay" id="overlay">
        <h1 id="overlayTitle">BIG WIN</h1>
        <h2 id="overlayValue">1000 â‚¬</h2>
    </div>

    <div class="bottom-ui-bar">
        <div class="ui-group">
            <div class="label">Guthaben</div>
            <div class="balance-display" id="balanceDisplay">5000.00 â‚¬</div>
        </div>
        <div class="ui-group">
            <div class="label">Einsatz</div>
            <input type="number" id="betInput" class="bet-input" value="10" min="1" onchange="validateBet()">
        </div>
        <button class="btn btn-auto" id="autoBtn" onclick="toggleAuto()">AUTO</button>
        <button class="btn btn-spin" id="spinBtn" onclick="manualSpin()">SPIN</button>
    </div>

    <script>
        // --- BALANCED MATH MODEL ---
        const SYMBOLS = {
            JAKOB: { type: 'image', src: 'dsc05439-1000x668.jpeg', weight: 2 }, 
            BOOK:  { type: 'emoji', char: 'ðŸ“–', weight: 4 }, 
            PHARAO:{ type: 'emoji', char: 'ðŸ‘º', weight: 6 },
            STATUE:{ type: 'emoji', char: 'ðŸ—¿', weight: 7 },
            A:     { type: 'text',  char: 'A',  cls: 'sym-A', weight: 12 },
            K:     { type: 'text',  char: 'K',  cls: 'sym-K', weight: 14 },
            Q:     { type: 'text',  char: 'Q',  cls: 'sym-Q', weight: 16 },
            J:     { type: 'text',  char: 'J',  cls: 'sym-J', weight: 18 },
            TEN:   { type: 'text',  char: '10', cls: 'sym-10', weight: 22 }
        };

        let symbolPool = [];
        for (let key in SYMBOLS) {
            for (let i = 0; i < SYMBOLS[key].weight; i++) symbolPool.push(key);
        }

        let balance = 5000.00;
        let isSpinning = false;
        let isAuto = false;
        let freeSpins = 0;

        const reels = [0,1,2,3,4].map(i => document.getElementById(`reel${i}`));
        const balEl = document.getElementById('balanceDisplay');
        const betInp = document.getElementById('betInput');
        const spinBtn = document.getElementById('spinBtn');
        const autoBtn = document.getElementById('autoBtn');
        const overlay = document.getElementById('overlay');
        const bonusText = document.getElementById('bonusText');

        reels.forEach(r => r.innerHTML = getRandomReelHTML());
        
        function getRandomKey() { return symbolPool[Math.floor(Math.random() * symbolPool.length)]; }

        function getSymbolHTML(key) {
            const s = SYMBOLS[key];
            if(s.type === 'image') return `<div class="symbol" data-key="${key}"><img src="${s.src}" class="jakob-symbol"></div>`;
            if(s.type === 'text') return `<div class="symbol" data-key="${key}"><span class="sym-text ${s.cls}">${s.char}</span></div>`;
            return `<div class="symbol" data-key="${key}"><span class="sym-emoji">${s.char}</span></div>`;
        }

        function getRandomReelHTML() {
            let html = '';
            for(let i=0; i<3; i++) html += getSymbolHTML(getRandomKey());
            return html;
        }

        function validateBet() {
            let val = parseFloat(betInp.value);
            if(isNaN(val) || val < 0.1) val = 0.10;
            betInp.value = val;
        }

        function toggleAuto() {
            isAuto = !isAuto;
            autoBtn.classList.toggle('active');
            // Nur starten, wenn nicht eh schon gedreht wird
            if(isAuto && !isSpinning) spin();
        }
        
        function manualSpin() { 
            // Bei manuellem Klick Auto ausmachen
            if(isAuto) toggleAuto(); 
            spin(); 
        }

        function spin() {
            if(isSpinning) return;
            let bet = parseFloat(betInp.value);

            // Einsatz abziehen (wenn keine Freispiele)
            if(freeSpins === 0) {
                if(balance < bet) { 
                    alert("Nicht genug Guthaben!"); 
                    // Auto Modus stoppen wenn pleite
                    if(isAuto) toggleAuto();
                    return; 
                }
                balance -= bet;
            } else {
                freeSpins--;
                updateFreeSpinUI();
            }
            updateUI();

            isSpinning = true;
            spinBtn.disabled = true;
            overlay.classList.remove('show');

            let finalGrid = [];
            reels.forEach((reel, i) => {
                reel.querySelectorAll('.symbol').forEach(s => s.classList.remove('win-anim'));
                let speed = 50;
                let timer = setInterval(() => reel.innerHTML = getRandomReelHTML(), speed);

                setTimeout(() => {
                    clearInterval(timer);
                    let colData = [];
                    let html = '';
                    for(let r=0; r<3; r++) {
                        let k = getRandomKey();
                        colData.push(k);
                        html += getSymbolHTML(k);
                    }
                    reel.innerHTML = html;
                    finalGrid.push(colData);
                    if(i === 4) checkWin(finalGrid, bet);
                }, 400 + (i * 200));
            });
        }

        function checkWin(grid, bet) {
            isSpinning = false; spinBtn.disabled = false;
            let win = 0;
            let triggerBonus = false;

            // 1. SCATTER (Buch)
            let books = 0;
            grid.forEach(col => col.forEach(key => { if(key === 'BOOK') books++; }));
            
            if(books >= 3) {
                triggerBonus = true;
                win += bet * books * 2; 
                if(freeSpins > 0) {
                    freeSpins += 10;
                    showOverlay("RETRIGGER!", "+10 SPIELE");
                } else {
                    freeSpins = 10;
                    showOverlay("BONUS!", "10 FREISPIELE");
                    updateFreeSpinUI();
                }
            }

            // 2. LINIE (Mitte)
            let line = grid.map(c => c[1]);
            let first = line[0];
            let count = 1;
            
            for(let i=1; i<5; i++) {
                if(line[i] === first || line[i] === 'BOOK' || first === 'BOOK') {
                    count++;
                    if(first === 'BOOK' && line[i] !== 'BOOK') first = line[i]; 
                } else {
                    break;
                }
            }

            if(count >= 3) {
                let mult = 5; 
                if(first === 'JAKOB') mult = 100;
                else if(first === 'PHARAO' || first === 'STATUE') mult = 30;
                else if(first === 'A' || first === 'K') mult = 10;
                
                let lineWin = bet * mult * (count - 2); 
                if(count > 3) lineWin *= 2;
                
                win += lineWin;
                for(let i=0; i<count; i++) reels[i].children[1].classList.add('win-anim');
                
                if(!triggerBonus && win > bet * 3) {
                    showOverlay("GEWINN!", win.toFixed(2) + " â‚¬");
                    if(win > bet * 20) confetti();
                }
            }

            if(win > 0) {
                balance += win;
                updateUI();
            }

            // --- BUGFIX LOGIK FÃœR AUTO SPIN UND FREISPIEL ENDE ---
            
            if (freeSpins > 0) {
                // Wir sind MITTEN im Freispiel -> Immer automatisch weiter
                setTimeout(spin, 1500);
            } 
            else {
                // Freispiele sind 0. Waren wir gerade im Bonus Modus?
                if (document.body.classList.contains('bonus-active')) {
                    // JA: Bonus ist JETZT vorbei.
                    // Erstmal UI aufrÃ¤umen
                    document.body.classList.remove('bonus-active');
                    bonusText.style.display = 'none';
                    spinBtn.innerText = "SPIN";
                    
                    // Kurze Pause, damit der Spieler checkt, dass der Bonus vorbei ist.
                    // Danach: Wenn Auto an ist, mit normalem Einsatz weiter.
                    if (isAuto) {
                        setTimeout(spin, 2500); 
                    }
                } 
                else if (isAuto) {
                    // Ganz normaler Auto-Spin im Basisspiel
                    let delay = (win > 0 || triggerBonus) ? 2000 : 600;
                    setTimeout(spin, delay);
                }
            }
        }

        function updateUI() { balEl.innerText = balance.toFixed(2) + " â‚¬"; }

        function updateFreeSpinUI() {
            if(freeSpins > 0) {
                document.body.classList.add('bonus-active');
                bonusText.style.display = 'block';
                bonusText.innerText = "FREISPIELE: " + freeSpins;
                spinBtn.innerText = freeSpins;
            } else {
                spinBtn.innerText = "SPIN";
            }
        }

        function showOverlay(t, v) {
            let el = document.getElementById('overlay');
            document.getElementById('overlayTitle').innerText = t;
            document.getElementById('overlayValue').innerText = v;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 1500);
        }

        function confetti() {
            for(let i=0; i<40; i++) {
                let p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random()*100+'vw';
                p.style.top = -10+'px';
                p.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                p.style.animation = `fall ${1+Math.random()}s linear`;
                document.body.appendChild(p);
                setTimeout(()=>p.remove(), 2000);
            }
        }
        
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
